generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model ApiKey {
  id           String    @id @default(uuid())
  workspace_id String
  public_key   String    @unique
  created_at   DateTime  @default(now())
  last_used_at DateTime?
  name         String    @default("Default Key")
  secret_hash  String?
  Workspace    Workspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

  @@index([public_key])
  @@index([secret_hash])
  @@index([workspace_id])
}

model Mission {
  id                String              @id @default(uuid())
  workspace_id      String
  title             String
  description       String
  target_url        String
  reward            String
  status            MissionStatus       @default(DRAFT)
  created_at        DateTime            @default(now())
  updated_at        DateTime            @updatedAt
  Workspace         Workspace           @relation(fields: [workspace_id], references: [id], onDelete: Cascade)
  MissionEnrollment MissionEnrollment[]

  @@index([status])
  @@index([workspace_id])
}

model MissionEnrollment {
  id         String           @id @default(uuid())
  mission_id String
  user_id    String
  status     EnrollmentStatus @default(PENDING)
  link_id    String?          @unique
  created_at DateTime         @default(now())
  updated_at DateTime         @updatedAt
  ShortLink  ShortLink?       @relation(fields: [link_id], references: [id])
  Mission    Mission          @relation(fields: [mission_id], references: [id], onDelete: Cascade)

  @@unique([mission_id, user_id])
  @@index([mission_id])
  @@index([user_id])
}

model ShortLink {
  id                String             @id @default(uuid())
  slug              String             @unique
  original_url      String
  workspace_id      String
  clicks            Int                @default(0)
  created_at        DateTime           @default(now())
  affiliate_id      String?
  MissionEnrollment MissionEnrollment?
  Workspace         Workspace          @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

  @@index([affiliate_id])
  @@index([slug])
  @@index([workspace_id])
}

model User {
  id            String   @id
  email         String   @unique
  password_hash String
  name          String
  role          UserRole
  created_at    DateTime @default(now())

  @@index([email])
}

model WebhookEndpoint {
  id           String    @id @default(uuid())
  workspace_id String
  description  String?
  secret       String?
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt
  Workspace    Workspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

  @@index([workspace_id])
}

/// Idempotency table for webhook events - prevents double processing
model ProcessedEvent {
  id             String   @id @default(uuid())
  event_id       String   @unique  /// Stripe event ID (evt_xxx)
  event_type     String   /// checkout.session.completed, invoice.paid, etc.
  workspace_id   String
  processed_at   DateTime @default(now())
  amount_cents   Int?     /// Amount processed
  net_cents      Int?     /// Net amount after fees
  stripe_fee     Int?     /// Stripe fee from balance_transaction
  
  @@index([event_id])
  @@index([workspace_id])
  @@index([processed_at])
}

model Workspace {
  id              String            @id @default(uuid())
  name            String
  slug            String            @unique
  owner_id        String
  created_at      DateTime          @default(now())
  ApiKey          ApiKey[]
  Domain          Domain[]
  Mission         Mission[]
  ShortLink       ShortLink[]
  WebhookEndpoint WebhookEndpoint[]
  WorkspaceMember WorkspaceMember[]
  Partner         Partner[]         /// Partners enrolled in this program

  @@index([owner_id])
  @@index([slug])
}

/// Custom domain for CNAME cloaking - enables First-Party tracking
model Domain {
  id           String    @id @default(uuid())
  name         String    @unique  /// Fully qualified domain name (e.g., track.startup.com)
  workspace_id String
  verified     Boolean   @default(false)
  verified_at  DateTime?
  created_at   DateTime  @default(now())
  Workspace    Workspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

  @@index([name])
  @@index([workspace_id])
}

model WorkspaceMember {
  id           String        @id @default(uuid())
  workspace_id String
  user_id      String
  role         WorkspaceRole @default(MEMBER)
  created_at   DateTime      @default(now())
  Workspace    Workspace     @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

  @@unique([workspace_id, user_id])
  @@index([user_id])
}

/// Rate Limit Hit tracking for dashboard alerting
/// Tracks when IP addresses hit rate limits on workspace links
model RateLimitHit {
  id           String   @id @default(uuid())
  workspace_id String?  /// Null if workspace couldn't be determined
  ip_address   String   /// IP that was rate limited
  path         String   /// Path that was accessed
  hit_type     String   /// 'link_rate_limit' or 'api_rate_limit'
  created_at   DateTime @default(now())

  @@index([workspace_id])
  @@index([ip_address])
  @@index([created_at])
}

enum EnrollmentStatus {
  PENDING
  APPROVED
  REJECTED
}

enum MissionStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum UserRole {
  STARTUP
  AFFILIATE
}

enum WorkspaceRole {
  OWNER
  MEMBER
}

// =============================================
// PARTNER COMMISSION SYSTEM (Dub.co Style)
// =============================================

/// Shadow Partner (Dub.co style) - linked to Program/Workspace
/// Enables "Shadow Tenancy" where partners can exist before creating an account
model Partner {
  id                  String          @id @default(cuid())
  program_id          String          /// FK to Workspace (Program)
  user_id             String?         /// Nullable for Shadow Users (no account yet)
  tenant_id           String          @unique /// External anchor ID for idempotent creation
  email               String
  name                String?
  stripe_connect_id   String?         /// Stripe Express account ID (acct_xxx)
  status              PartnerStatus   @default(PENDING)
  payouts_enabled_at  DateTime?
  created_at          DateTime        @default(now())
  updated_at          DateTime        @updatedAt
  
  Program             Workspace       @relation(fields: [program_id], references: [id], onDelete: Cascade)
  Commissions         Commission[]

  @@unique([program_id, email])  /// Unique partner per program
  @@index([email])
  @@index([tenant_id])
  @@index([user_id])
  @@index([program_id])
}

/// Commission Ledger with State Machine
/// Tracks all commission events with full audit trail
model Commission {
  id                String            @id @default(cuid())
  partner_id        String
  program_id        String            /// Denormalized for faster queries
  sale_id           String            @unique  /// Stripe checkout session ID (cs_xxx)
  link_id           String?           /// ShortLink that generated this sale
  gross_amount      Int               /// In cents
  net_amount        Int               /// After Stripe fees + tax
  stripe_fee        Int               @default(0) /// Stripe fee in cents
  tax_amount        Int               @default(0) /// Tax in cents
  commission_amount Int               /// Calculated commission in cents
  commission_rate   String            /// Original rate: "5€" or "10%"
  commission_type   CommissionType
  currency          String            @default("EUR")
  status            CommissionStatus  @default(PENDING)
  matured_at        DateTime?         /// When transitioned to DUE
  paid_at           DateTime?         /// When payout completed
  clawback_at       DateTime?         /// When refund received
  clawback_reason   String?           /// Reason for clawback
  created_at        DateTime          @default(now())
  updated_at        DateTime          @updatedAt

  Partner           Partner           @relation(fields: [partner_id], references: [id], onDelete: Cascade)

  @@index([partner_id])
  @@index([program_id])
  @@index([status])
  @@index([created_at])
  @@index([sale_id])
}

/// Partner Balance for tracking payouts and negative balances (clawbacks)
model PartnerBalance {
  id          String   @id @default(cuid())
  partner_id  String   @unique
  balance     Int      @default(0) /// Current balance in cents (can be negative)
  pending     Int      @default(0) /// Pending commissions (PENDING status)
  due         Int      @default(0) /// Due for payout (DUE status)
  paid_total  Int      @default(0) /// Total ever paid out
  updated_at  DateTime @updatedAt

  @@index([partner_id])
}

enum PartnerStatus {
  PENDING   /// Awaiting approval
  APPROVED  /// Can earn commissions
  BANNED    /// Blocked from program
}

enum CommissionStatus {
  PENDING     /// Waiting for 30-day maturation
  DUE         /// Matured, ready for payout
  PROCESSING  /// Payout in progress
  PAID        /// Completed
  CLAWBACK    /// Refunded/cancelled
}

enum CommissionType {
  FIXED       /// Fixed amount (e.g., 5€)
  PERCENTAGE  /// Percentage of net revenue
}
