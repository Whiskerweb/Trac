generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id             String    @id @default(uuid())
  email          String    @unique
  password_hash  String
  name           String
  role           UserRole
  created_at     DateTime  @default(now())
  claimed_links  Link[]    @relation("LinkClaimer")
  owned_projects Project[] @relation("ProjectOwner")

  @@index([email])
}

model Link {
  id              String   @id @unique
  destination_url String
  project_id      String
  user_id         String
  name            String?
  created_at      DateTime @default(now())
  project         Project  @relation(fields: [project_id], references: [id], onDelete: Cascade)
  claimer         User     @relation("LinkClaimer", fields: [user_id], references: [id])

  @@index([project_id])
  @@index([user_id])
}

model Project {
  id         String   @id @default(uuid())
  name       String
  public_key String   @unique
  created_at DateTime @default(now())
  website    String?
  user_id    String
  links      Link[]
  owner      User     @relation("ProjectOwner", fields: [user_id], references: [id])

  @@index([public_key])
  @@index([user_id])
}

model ShortLink {
  id           String             @id @default(uuid())
  slug         String             @unique
  original_url String
  workspace_id String             // Startup owner (for analytics/API attribution)
  affiliate_id String?            // Student/Affiliate owner (for commission tracking)
  clicks       Int                @default(0)
  created_at   DateTime           @default(now())
  enrollment   MissionEnrollment?

  @@index([slug])
  @@index([workspace_id])
  @@index([affiliate_id])
}

model ApiKey {
  id           String    @id @default(uuid())
  workspace_id String    @unique
  public_key   String    @unique
  created_at   DateTime  @default(now())
  last_used_at DateTime?

  @@index([public_key])
  @@index([workspace_id])
}

model WebhookEndpoint {
  id           String   @id
  workspace_id String   @unique
  description  String?
  secret       String?
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  @@index([workspace_id])
}

model Mission {
  id           String              @id @default(uuid())
  workspace_id String
  title        String
  description  String
  target_url   String
  reward       String
  status       MissionStatus       @default(DRAFT)
  created_at   DateTime            @default(now())
  updated_at   DateTime            @updatedAt
  enrollments  MissionEnrollment[]

  @@index([workspace_id])
  @@index([status])
}

model MissionEnrollment {
  id         String           @id @default(uuid())
  mission_id String
  user_id    String
  status     EnrollmentStatus @default(PENDING)
  link_id    String?          @unique
  created_at DateTime         @default(now())
  updated_at DateTime         @updatedAt
  link       ShortLink?       @relation(fields: [link_id], references: [id])
  mission    Mission          @relation(fields: [mission_id], references: [id], onDelete: Cascade)

  @@unique([mission_id, user_id])
  @@index([user_id])
  @@index([mission_id])
}

enum UserRole {
  STARTUP
  AFFILIATE
}

enum MissionStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum EnrollmentStatus {
  PENDING
  APPROVED
  REJECTED
}
