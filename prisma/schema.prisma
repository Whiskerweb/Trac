generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model ApiKey {
  id           String    @id @default(uuid())
  workspace_id String
  public_key   String    @unique
  created_at   DateTime  @default(now())
  last_used_at DateTime?
  name         String    @default("Default Key")
  secret_hash  String?
  Workspace    Workspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

  @@index([public_key])
  @@index([secret_hash])
  @@index([workspace_id])
}

model Mission {
  id                String              @id @default(uuid())
  workspace_id      String
  title             String
  description       String
  target_url        String
  reward            String
  status            MissionStatus       @default(DRAFT)
  created_at        DateTime            @default(now())
  updated_at        DateTime            @updatedAt
  Workspace         Workspace           @relation(fields: [workspace_id], references: [id], onDelete: Cascade)
  MissionEnrollment MissionEnrollment[]

  @@index([status])
  @@index([workspace_id])
}

model MissionEnrollment {
  id         String           @id @default(uuid())
  mission_id String
  user_id    String
  status     EnrollmentStatus @default(PENDING)
  link_id    String?          @unique
  created_at DateTime         @default(now())
  updated_at DateTime         @updatedAt
  ShortLink  ShortLink?       @relation(fields: [link_id], references: [id])
  Mission    Mission          @relation(fields: [mission_id], references: [id], onDelete: Cascade)

  @@unique([mission_id, user_id])
  @@index([mission_id])
  @@index([user_id])
}

model ShortLink {
  id                String             @id @default(uuid())
  slug              String             @unique
  original_url      String
  workspace_id      String
  clicks            Int                @default(0)
  created_at        DateTime           @default(now())
  affiliate_id      String?
  MissionEnrollment MissionEnrollment?
  Workspace         Workspace          @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

  @@index([affiliate_id])
  @@index([slug])
  @@index([workspace_id])
}

model User {
  id            String   @id
  email         String   @unique
  password_hash String
  name          String
  role          UserRole
  created_at    DateTime @default(now())

  @@index([email])
}

model WebhookEndpoint {
  id           String    @id @default(uuid())
  workspace_id String
  description  String?
  secret       String?
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt
  Workspace    Workspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

  @@index([workspace_id])
}

/// Idempotency table for webhook events - prevents double processing
model ProcessedEvent {
  id             String   @id @default(uuid())
  event_id       String   @unique  /// Stripe event ID (evt_xxx)
  event_type     String   /// checkout.session.completed, invoice.paid, etc.
  workspace_id   String
  processed_at   DateTime @default(now())
  amount_cents   Int?     /// Amount processed
  net_cents      Int?     /// Net amount after fees
  stripe_fee     Int?     /// Stripe fee from balance_transaction
  
  @@index([event_id])
  @@index([workspace_id])
  @@index([processed_at])
}

model Workspace {
  id              String            @id @default(uuid())
  name            String
  slug            String            @unique
  owner_id        String
  created_at      DateTime          @default(now())
  ApiKey          ApiKey[]
  Domain          Domain[]
  Mission         Mission[]
  ShortLink       ShortLink[]
  WebhookEndpoint WebhookEndpoint[]
  WorkspaceMember WorkspaceMember[]

  @@index([owner_id])
  @@index([slug])
}

/// Custom domain for CNAME cloaking - enables First-Party tracking
model Domain {
  id           String    @id @default(uuid())
  name         String    @unique  /// Fully qualified domain name (e.g., track.startup.com)
  workspace_id String
  verified     Boolean   @default(false)
  verified_at  DateTime?
  created_at   DateTime  @default(now())
  Workspace    Workspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

  @@index([name])
  @@index([workspace_id])
}

model WorkspaceMember {
  id           String        @id @default(uuid())
  workspace_id String
  user_id      String
  role         WorkspaceRole @default(MEMBER)
  created_at   DateTime      @default(now())
  Workspace    Workspace     @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

  @@unique([workspace_id, user_id])
  @@index([user_id])
}

/// Rate Limit Hit tracking for dashboard alerting
/// Tracks when IP addresses hit rate limits on workspace links
model RateLimitHit {
  id           String   @id @default(uuid())
  workspace_id String?  /// Null if workspace couldn't be determined
  ip_address   String   /// IP that was rate limited
  path         String   /// Path that was accessed
  hit_type     String   /// 'link_rate_limit' or 'api_rate_limit'
  created_at   DateTime @default(now())

  @@index([workspace_id])
  @@index([ip_address])
  @@index([created_at])
}

enum EnrollmentStatus {
  PENDING
  APPROVED
  REJECTED
}

enum MissionStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum UserRole {
  STARTUP
  AFFILIATE
}

enum WorkspaceRole {
  OWNER
  MEMBER
}
