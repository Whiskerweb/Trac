generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model ApiKey {
  id           String    @id @default(uuid())
  workspace_id String
  public_key   String    @unique
  created_at   DateTime  @default(now())
  last_used_at DateTime?
  name         String    @default("Default Key")
  secret_hash  String?
  /// API permissions
  scopes       String[]  @default(["analytics:read", "links:write"])
  Workspace    Workspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

  @@index([public_key])
  @@index([secret_hash])
  @@index([workspace_id])
}

model Mission {
  id           String            @id @default(uuid())
  workspace_id String
  title        String
  description  String
  target_url   String
  /// Legacy display string (e.g., "5€/lead + 10%/sale")
  reward       String
  status       MissionStatus     @default(DRAFT)
  created_at   DateTime          @default(now())
  updated_at   DateTime          @updatedAt
  archived_at  DateTime?
  /// Net Revenue, ROI, Fixed
  gain_type    String?
  /// SaaS, E-commerce, Finance, etc.
  industry     String?
  visibility   MissionVisibility @default(PUBLIC)

  // === LEGACY REWARD CONFIGURATION (kept for migration) ===
  /// Sale (for subscriptions/purchases) or Lead (for sign-ups)
  reward_type          RewardType          @default(SALE)
  /// One-off (first purchase) or Recurring (subscription)
  commission_structure CommissionStructure @default(ONE_OFF)
  /// Flat ($) or Percentage (%)
  reward_structure     RewardStructure     @default(FLAT)
  /// Amount in cents (if Flat) or percentage (if %)
  reward_amount        Float               @default(0)
  /// Duration in months for recurring commissions (3-48)
  recurring_duration   Int?

  // === NEW: MULTI-COMMISSION CONFIGURATION ===
  /// Enable lead commission (pay per sign-up)
  lead_enabled         Boolean             @default(false)
  /// Lead reward amount in EUR (fixed only)
  lead_reward_amount   Float?

  /// Enable sale commission (pay per purchase)
  sale_enabled         Boolean             @default(true)
  /// Sale reward amount (EUR if FLAT, % if PERCENTAGE)
  sale_reward_amount   Float?
  /// Sale reward structure (FLAT or PERCENTAGE)
  sale_reward_structure RewardStructure?

  /// Enable recurring commission (pay per subscription renewal)
  recurring_enabled         Boolean          @default(false)
  /// Recurring reward amount per renewal
  recurring_reward_amount   Float?
  /// Recurring reward structure (FLAT or PERCENTAGE)
  recurring_reward_structure RewardStructure?
  /// Recurring duration in months (null = Lifetime)
  recurring_duration_months Int?

  // === NEW: COUNTRY FILTERING ===
  /// Country filter type: ALL, INCLUDE (only listed), EXCLUDE (all except listed)
  country_filter_type  CountryFilterType   @default(ALL)
  /// List of ISO 3166-1 alpha-2 country codes (e.g., ["FR", "DE", "ES"])
  country_filter_list  String[]            @default([])

  // === COMPANY BRANDING ===
  company_name String?
  logo_url     String?

  // === SUPPORT INFO ===
  contact_email   String?
  help_center_url String?

  // === INVITE-ONLY ACCESS ===
  /// Unique code for INVITE_ONLY missions (allows joining via /invite/[code])
  invite_code String? @unique

  /// Whether this mission is visible on the hosted affiliate portal
  portal_visible     Boolean             @default(true)

  /// If set, this mission is exclusive to an organization (not shown in marketplace)
  organization_id    String?
  /// The template mission this was cloned from
  source_mission_id  String?

  Workspace            Workspace              @relation(fields: [workspace_id], references: [id], onDelete: Cascade)
  Organization         Organization?          @relation("OrgExclusiveMissions", fields: [organization_id], references: [id])
  SourceMission        Mission?               @relation("MissionTemplate", fields: [source_mission_id], references: [id], onDelete: SetNull)
  DerivedMissions      Mission[]              @relation("MissionTemplate")
  Contents             MissionContent[]
  MissionEnrollment    MissionEnrollment[]
  Requests             ProgramRequest[]
  OrganizationMissions OrganizationMission[]
  GroupMissions        GroupMission[]

  @@index([status])
  @@index([visibility])
  @@index([workspace_id])
  @@index([organization_id])
  @@index([archived_at])
}

model MissionEnrollment {
  id         String           @id @default(uuid())
  mission_id String
  user_id    String
  status     EnrollmentStatus @default(PENDING)
  link_id    String?          @unique
  /// If enrolled via an organization
  organization_mission_id String?
  /// If enrolled via a seller group
  group_mission_id String?
  created_at DateTime         @default(now())
  updated_at DateTime         @updatedAt
  ShortLink  ShortLink?       @relation(fields: [link_id], references: [id])
  Mission    Mission          @relation(fields: [mission_id], references: [id], onDelete: Cascade)

  @@unique([mission_id, user_id, group_mission_id])
  @@index([mission_id])
  @@index([user_id])
  @@index([organization_mission_id])
  @@index([group_mission_id])
}

model ShortLink {
  id                String             @id @default(uuid())
  slug              String             @unique
  original_url      String
  workspace_id      String
  clicks            Int                @default(0)
  created_at        DateTime           @default(now())
  affiliate_id      String?
  channel           String?
  campaign          String?
  /// FK to MarketingCampaign entity
  campaign_id       String?
  /// FK to MarketingFolder entity
  folder_id         String?
  link_type         String             @default("affiliate")
  utm_source        String?
  utm_medium        String?
  utm_campaign      String?
  utm_term          String?
  utm_content       String?
  og_title          String?
  og_description    String?
  og_image          String?
  MissionEnrollment MissionEnrollment?
  Workspace         Workspace          @relation(fields: [workspace_id], references: [id], onDelete: Cascade)
  Campaign          MarketingCampaign? @relation(fields: [campaign_id], references: [id], onDelete: SetNull)
  Folder            MarketingFolder?   @relation(fields: [folder_id], references: [id], onDelete: SetNull)
  tags              MarketingTag[]     @relation("ShortLinkTags")

  @@index([affiliate_id])
  @@index([slug])
  @@index([workspace_id])
  @@index([link_type])
  @@index([channel])
  @@index([campaign])
  @@index([campaign_id])
  @@index([folder_id])
}

model User {
  id            String   @id
  email         String   @unique
  password_hash String
  name          String
  role          UserRole
  created_at    DateTime @default(now())

  @@index([email])
}

model WebhookEndpoint {
  id           String    @id @default(uuid())
  workspace_id String
  description  String?
  secret       String?
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt
  Workspace    Workspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

  @@index([workspace_id])
}

/// Idempotency table for webhook events - prevents double processing
model ProcessedEvent {
  id           String   @id @default(uuid())
  /// Stripe event ID (evt_xxx)
  event_id     String   @unique
  /// checkout.session.completed, invoice.paid, etc.
  event_type   String
  workspace_id String
  processed_at DateTime @default(now())
  /// Amount processed
  amount_cents Int?
  /// Net amount after fees
  net_cents    Int?
  /// Stripe fee from balance_transaction
  stripe_fee   Int?

  @@index([event_id])
  @@index([workspace_id])
  @@index([processed_at])
}

model Workspace {
  id              String            @id @default(uuid())
  name            String
  slug            String            @unique
  owner_id        String
  created_at      DateTime          @default(now())
  ApiKey           ApiKey[]
  Conversations    Conversation[]
  Customer         Customer[]
  Discount         Discount?
  Domain           Domain[]
  LeadEvent        LeadEvent[]
  Mission          Mission[]
  Profile          WorkspaceProfile?
  Seller           Seller[]
  ShortLink        ShortLink[]
  WebhookEndpoint  WebhookEndpoint[]
  WorkspaceMember  WorkspaceMember[]
  StartupPayment    StartupPayment[]
  MarketingTag      MarketingTag[]
  MarketingCampaign MarketingCampaign[]
  MarketingFolder   MarketingFolder[]

  /// Hosted affiliate portal
  portal_enabled       Boolean @default(false)
  portal_welcome_text  String?
  portal_primary_color String?  @default("#7C3AED")
  portal_headline      String?
  portal_logo_url      String?

  @@index([owner_id])
  @@index([slug])
}

/// Startup profile - public-facing company information
model WorkspaceProfile {
  id             String   @id @default(cuid())
  workspace_id   String   @unique
  /// Company description / about
  description    String?
  /// Logo URL (uploaded image)
  logo_url       String?
  /// Company website
  website_url    String?
  /// Industry / sector
  industry       String?
  /// Company size (1-10, 11-50, 51-200, 201-500, 500+)
  company_size   String?
  /// Year founded
  founded_year   String?
  /// Headquarters location
  headquarters   String?

  // === SOCIAL LINKS ===
  twitter_url    String?
  linkedin_url   String?
  instagram_url  String?
  youtube_url    String?
  tiktok_url     String?
  github_url     String?

  // === DOCUMENTS ===
  /// Pitch deck PDF URL
  pitch_deck_url String?
  /// Additional document URL
  doc_url        String?

  created_at     DateTime  @default(now())
  updated_at     DateTime  @updatedAt
  Workspace      Workspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

  @@index([workspace_id])
}

/// Custom domain for CNAME cloaking - enables First-Party tracking
model Domain {
  id           String    @id @default(uuid())
  /// Fully qualified domain name (e.g., track.startup.com)
  name         String    @unique
  workspace_id String
  verified     Boolean   @default(false)
  verified_at  DateTime?
  created_at   DateTime  @default(now())
  Workspace    Workspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

  @@index([name])
  @@index([workspace_id])
}

model WorkspaceMember {
  id           String        @id @default(uuid())
  workspace_id String
  user_id      String
  role         WorkspaceRole @default(MEMBER)
  created_at   DateTime      @default(now())
  Workspace    Workspace     @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

  @@unique([workspace_id, user_id])
  @@index([user_id])
}

/// Rate Limit Hit tracking for dashboard alerting
/// Tracks when IP addresses hit rate limits on workspace links
model RateLimitHit {
  id           String   @id @default(uuid())
  /// Null if workspace couldn't be determined
  workspace_id String?
  /// IP that was rate limited
  ip_address   String
  /// Path that was accessed
  path         String
  /// 'link_rate_limit' or 'api_rate_limit'
  hit_type     String
  created_at   DateTime @default(now())

  @@index([workspace_id])
  @@index([ip_address])
  @@index([created_at])
}

/// Customer for Lead Tracking - Links click_id to customer_id permanently
/// Enables lifetime attribution even after cookie expiration (Dub-style)
model Customer {
  id           String      @id @default(cuid())
  workspace_id String
  /// Customer ID in client's system (e.g., user_123)
  external_id  String
  /// First-click attribution - stored permanently
  click_id     String?
  /// The link that was clicked
  link_id      String?
  /// Partner who referred this customer
  affiliate_id String?
  name         String?
  email        String?
  avatar       String?
  country      String?
  created_at   DateTime    @default(now())
  updated_at   DateTime    @updatedAt
  Workspace    Workspace   @relation(fields: [workspace_id], references: [id], onDelete: Cascade)
  LeadEvents   LeadEvent[]

  @@unique([workspace_id, external_id])
  @@index([workspace_id])
  @@index([click_id])
  @@index([email])
}

/// Lead conversion event - Tracks when customer becomes a lead
/// Deduplicated on (customer_id + event_name) to prevent duplicates
model LeadEvent {
  id           String    @id @default(cuid())
  workspace_id String
  customer_id  String
  click_id     String?
  link_id      String?
  /// "Sign Up", "Demo Booked", "Free Trial"
  event_name   String
  /// Quantity or value associated
  event_value  Float?
  /// Custom data
  metadata     Json?
  created_at   DateTime  @default(now())
  Customer     Customer  @relation(fields: [customer_id], references: [id], onDelete: Cascade)
  Workspace    Workspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

  @@unique([customer_id, event_name])
  @@index([workspace_id])
  @@index([customer_id])
  @@index([click_id])
}

/// Mission Resources - Rich content for partner briefing
model MissionContent {
  id          String      @id @default(cuid())
  mission_id  String
  type        ContentType
  /// URL for YOUTUBE, PDF, LINK types
  url         String?
  title       String
  description String?
  order       Int         @default(0)
  created_at  DateTime    @default(now())
  Mission     Mission     @relation(fields: [mission_id], references: [id], onDelete: Cascade)

  @@index([mission_id])
}

/// Program Access Requests - For PRIVATE missions
model ProgramRequest {
  id          String        @id @default(cuid())
  seller_id   String
  mission_id  String
  status      RequestStatus @default(PENDING)
  /// Partner's application message
  message     String?
  /// When the request was approved/rejected
  reviewed_at DateTime?
  created_at  DateTime      @default(now())
  updated_at  DateTime      @updatedAt
  Mission     Mission       @relation(fields: [mission_id], references: [id], onDelete: Cascade)
  Seller      Seller        @relation(fields: [seller_id], references: [id], onDelete: Cascade)

  @@unique([seller_id, mission_id])
  @@index([seller_id])
  @@index([mission_id])
  @@index([status])
}

/// Shadow Partner (Dub.co style) - linked to Program/Workspace
/// Enables "Shadow Tenancy" where partners can exist before creating an account
model Seller {
  /// TODO: Use trac_pn_ prefix via application layer
  id                 String       @id @default(cuid())
  /// Optional for Global Partners
  program_id         String?
  /// Nullable for Shadow Users (no account yet)
  user_id            String?
  /// External anchor ID for idempotent creation
  tenant_id          String       @unique
  email              String
  name               String?
  /// Stripe Express account ID (acct_xxx)
  stripe_connect_id  String?
  status             SellerStatus @default(PENDING)
  payouts_enabled_at DateTime?
  /// 0-4 onboarding progress
  onboarding_step    Int          @default(0)

  // === MULTI-PAYOUT OPTIONS ===
  /// Preferred payout method
  payout_method PayoutMethod @default(PLATFORM)
  /// PayPal email for payouts
  paypal_email  String?
  /// IBAN for SEPA transfers
  iban          String?
  /// BIC/SWIFT code
  bic           String?

  // === REFERRAL / PARRAINAGE ===
  /// Seller who referred this seller (gen 1 parent)
  referred_by   String?
  /// Unique referral code for sharing (e.g. "ab12cd34")
  referral_code String?   @unique
  /// When this seller was referred (for 1-year expiry)
  referred_at   DateTime?

  created_at          DateTime             @default(now())
  updated_at          DateTime             @updatedAt
  Commissions         Commission[]
  Conversations       Conversation[]
  Program             Workspace?           @relation(fields: [program_id], references: [id], onDelete: Cascade)
  Profile             SellerProfile?
  Requests            ProgramRequest[]
  GiftCardRedemptions GiftCardRedemption[]
  LeadOrganizations   Organization[]       @relation("OrgLeader")
  OrgMemberships      OrganizationMember[]
  GroupCreated        SellerGroup[]        @relation("GroupCreator")
  GroupMembership     SellerGroupMember?
  Referrer            Seller?              @relation("SellerReferral", fields: [referred_by], references: [id], onDelete: SetNull)
  Referrals           Seller[]             @relation("SellerReferral")

  @@unique([program_id, email])
  @@index([email])
  @@index([tenant_id])
  @@index([user_id])
  @@index([program_id])
  @@index([referred_by])
  @@index([referred_at])
}

/// Partner Profile - Onboarding data and social links
model SellerProfile {
  id            String       @id @default(cuid())
  seller_id     String       @unique
  bio           String?

  // === SOCIAL LINKS ===
  tiktok_url    String?
  instagram_url String?
  twitter_url   String?
  youtube_url   String?
  website_url   String?
  linkedin_url  String?

  // === PROFILE INFO ===
  /// Country of residence
  country       String?
  /// Individual or Company
  profile_type  ProfileType? @default(INDIVIDUAL)

  // === EXPERTISE & PREFERENCES ===
  /// Array of industry interests (AI, SaaS, Sales, etc.)
  industry_interests  Json?
  /// Monthly traffic range (< 1,000 | 1,000 - 10,000 | etc.)
  monthly_traffic     String?
  /// Earning preferences (revShare, cpc, cpl, oneTime)
  earning_preferences Json?
  /// Sales channels (blogs, newsletters, socialMedia, etc.)
  sales_channels      Json?
  /// Main activity type (Content Creator, Sales Rep, etc.)
  activity_type       ActivityType?

  // === MEDIA & DOCUMENTS ===
  /// Profile photo URL (uploaded image)
  avatar_url    String?
  /// Portfolio link
  portfolio_url String?
  /// CV file URL (PDF upload)
  cv_url        String?

  /// "Get Discovered" progress (0-100)
  profile_score Int      @default(0)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  Seller        Seller   @relation(fields: [seller_id], references: [id], onDelete: Cascade)

  @@index([seller_id])
}

/// Profile type for sellers
enum ProfileType {
  INDIVIDUAL
  COMPANY
}

/// Activity type for sellers
enum ActivityType {
  CONTENT_CREATOR
  SALES_REP
  INFLUENCER
  MARKETER
  BLOGGER
  DEVELOPER
  CONSULTANT
  OTHER
}

/// Commission Ledger with State Machine
/// Tracks all commission events with full audit trail
model Commission {
  id                String           @id @default(cuid())
  seller_id         String
  /// Denormalized for faster queries
  program_id        String
  /// Stripe checkout session ID (cs_xxx) or invoice ID (in_xxx)
  sale_id           String           @unique
  /// ShortLink that generated this sale
  link_id           String?
  /// In cents
  gross_amount      Int
  /// After Stripe fees + tax
  net_amount        Int
  /// Stripe fee in cents
  stripe_fee        Int              @default(0)
  /// Tax in cents
  tax_amount        Int              @default(0)
  /// Calculated commission in cents (what partner receives)
  commission_amount Int
  /// Traaaction platform fee in cents (15%)
  platform_fee      Int              @default(0)
  /// Original rate: "5€" or "10%"
  commission_rate   String
  commission_type   CommissionType
  currency          String           @default("EUR")
  status            CommissionStatus @default(PENDING)
  /// Source of this commission (LEAD, SALE, or RECURRING)
  commission_source CommissionSource @default(SALE)

  // === RECURRING TRACKING ===
  /// Stripe subscription ID (sub_xxx) for recurring
  subscription_id String?
  /// Invoice number for this commission (1, 2, 3...)
  recurring_month Int?
  /// Max months configured in mission (null = Lifetime)
  recurring_max   Int?

  // === MATURATION ===
  /// Days before PENDING → PROCEED (30 days = refund protection)
  hold_days       Int       @default(30)
  /// When transitioned to PROCEED
  matured_at      DateTime?
  /// When payout completed
  paid_at         DateTime?
  /// When refund received
  clawback_at     DateTime?
  /// Reason for clawback
  clawback_reason String?

  // === STARTUP PAYMENT STATUS ===
  /// Has startup paid this commission to partners?
  startup_payment_status StartupPaymentStatus @default(UNPAID)
  /// Reference to batch payment
  startup_payment_id     String?

  // === ORGANIZATION SPLIT ===
  /// For leader commissions: points to the member's commission ID
  org_parent_commission_id String?
  /// Links to the OrganizationMission that generated this commission
  organization_mission_id  String?

  // === GROUP ===
  /// SellerGroup ID if this commission is from a group sale (all revenue goes to group creator)
  group_id                       String?

  // === REFERRAL TRACKING ===
  /// Points to the original commission that triggered this referral bonus
  referral_source_commission_id String?
  /// Generation depth: 1 = direct referrer, 2 = gen2, 3 = gen3
  referral_generation            Int?

  created_at     DateTime        @default(now())
  updated_at     DateTime        @updatedAt
  Seller         Seller          @relation(fields: [seller_id], references: [id], onDelete: Cascade)
  StartupPayment StartupPayment? @relation(fields: [startup_payment_id], references: [id])

  @@index([seller_id])
  @@index([program_id])
  @@index([status])
  @@index([created_at])
  @@index([sale_id])
  @@index([subscription_id])
  @@index([startup_payment_status])
  @@index([link_id])
  @@index([org_parent_commission_id])
  @@index([organization_mission_id])
  @@index([referral_source_commission_id])
  @@index([referral_generation])
  @@index([group_id])
}

/// Partner Balance for tracking payouts and negative balances (clawbacks)
model SellerBalance {
  id         String   @id @default(cuid())
  seller_id  String   @unique
  /// Current balance in cents (can be negative)
  balance    Int      @default(0)
  /// Pending commissions (PENDING status)
  pending    Int      @default(0)
  /// Due for payout (DUE status)
  due        Int      @default(0)
  /// Total ever paid out
  paid_total Int      @default(0)
  updated_at DateTime @updatedAt

  @@index([seller_id])
}

// === ORGANIZATION MODELS ===

/// Seller organization — leader manages a group of sellers
model Organization {
  id                 String                  @id @default(cuid())
  name               String
  description        String?
  logo_url           String?
  /// Seller.id of the organization leader
  leader_id          String
  status             OrganizationStatus      @default(PENDING)
  visibility         OrganizationVisibility  @default(PUBLIC)
  slug               String?                 @unique
  invite_code        String?                 @unique
  /// Why the leader wants to create this org (admin review)
  motivation         String?
  /// Expected audience size: "< 10", "10-50", "50-200", "200+"
  estimated_audience String?
  created_at         DateTime                @default(now())
  updated_at         DateTime                @updatedAt

  Leader            Seller               @relation("OrgLeader", fields: [leader_id], references: [id])
  Members           OrganizationMember[]
  Missions          OrganizationMission[]
  ExclusiveMissions Mission[]            @relation("OrgExclusiveMissions")

  @@index([leader_id])
  @@index([status])
}

/// Membership linking a seller to an organization
model OrganizationMember {
  id              String          @id @default(cuid())
  organization_id String
  seller_id       String
  status          OrgMemberStatus @default(PENDING)
  /// seller_id of the leader if invitation (null if seller applied)
  invited_by      String?
  created_at      DateTime        @default(now())

  Organization Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  Seller       Seller       @relation(fields: [seller_id], references: [id])

  @@unique([organization_id, seller_id])
  @@index([seller_id])
}

/// Contract between a startup and an org for a specific mission
model OrganizationMission {
  id              String @id @default(cuid())
  organization_id String
  mission_id      String

  /// Total commission offered by startup (e.g., "40%" or "10€") — includes 15% platform fee
  total_reward  String
  /// Leader's cut per sale, set by leader at acceptance (e.g., "5%" or "1.50€")
  leader_reward String?
  /// Member's cut per sale, auto-calculated at acceptance (e.g., "20%" or "7€")
  member_reward String?

  status      OrgMissionStatus @default(PROPOSED)
  /// workspace_id of the startup that proposed
  proposed_by String
  accepted_at DateTime?
  created_at  DateTime         @default(now())

  Organization Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  Mission      Mission      @relation(fields: [mission_id], references: [id])

  @@unique([organization_id, mission_id])
  @@index([mission_id])
}

// === DISCOUNTS ===

/// Discount for dual-sided incentives - linked to Program (Workspace)
/// Enables "{partner} vous offre {discount}%" banners
model Discount {
  id             String       @id @default(cuid())
  /// Program/Mission that offers this discount
  workspace_id   String       @unique
  /// 25 = 25% or 25€ depending on type
  amount         Float
  type           DiscountType @default(PERCENTAGE)
  /// Max months for subscription discounts
  max_duration   Int?
  /// Stripe coupon ID (production)
  coupon_id      String?
  /// Stripe coupon ID (test)
  coupon_test_id String?
  active         Boolean      @default(true)
  created_at     DateTime     @default(now())
  updated_at     DateTime     @updatedAt
  Workspace      Workspace    @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

  @@index([workspace_id])
  @@index([active])
}

/// Conversation between Startup (Workspace) and Partner
model Conversation {
  id             String    @id @default(cuid())
  workspace_id   String
  seller_id      String
  /// Preview of last message
  last_message   String?
  /// For sorting
  last_at        DateTime  @default(now())
  /// Unread count for startup
  unread_startup Int       @default(0)
  /// Unread count for partner
  unread_partner Int       @default(0)
  created_at     DateTime  @default(now())
  updated_at     DateTime  @updatedAt
  Seller         Seller    @relation(fields: [seller_id], references: [id], onDelete: Cascade)
  Workspace      Workspace @relation(fields: [workspace_id], references: [id], onDelete: Cascade)
  Messages       Message[]

  @@unique([workspace_id, seller_id])
  @@index([workspace_id])
  @@index([seller_id])
  @@index([last_at])
}

/// Message in a Conversation
model Message {
  id              String              @id @default(cuid())
  conversation_id String
  sender_type     SenderType
  content         String
  /// Special message type for invitations
  is_invitation   Boolean             @default(false)
  /// Reference to ProgramRequest if invitation
  invitation_id   String?
  /// Rich message type (TEXT for normal messages)
  message_type    MessageType         @default(TEXT)
  /// Structured data for rich messages (deal info, mission details, etc.)
  metadata        Json?
  /// Action status for interactive cards (null for TEXT messages)
  action_status   MessageActionStatus?
  read_at         DateTime?
  created_at      DateTime            @default(now())
  Conversation    Conversation        @relation(fields: [conversation_id], references: [id], onDelete: Cascade)

  @@index([conversation_id])
  @@index([created_at])
  @@index([message_type, action_status])
}

enum EnrollmentStatus {
  PENDING
  APPROVED
  REJECTED
  ARCHIVED
}

enum MissionStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum UserRole {
  STARTUP
  AFFILIATE
}

enum WorkspaceRole {
  OWNER
  MEMBER
}

enum MissionVisibility {
  /// Listed in Marketplace, anyone can join
  PUBLIC
  /// Listed but requires approval
  PRIVATE
  /// Only visible to invited partners
  INVITE_ONLY
}

enum ContentType {
  YOUTUBE
  PDF
  LINK
  TEXT
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum SellerStatus {
  /// Awaiting approval
  PENDING
  /// Can earn commissions
  APPROVED
  /// Blocked from program
  BANNED
}

enum CommissionStatus {
  /// Waiting for maturation period
  PENDING
  /// Approved for payout (replaces DUE/PROCESSING)
  PROCEED
  /// Payout completed (replaces PAID)
  COMPLETE
}

enum CommissionType {
  /// Fixed amount (e.g., 5€)
  FIXED
  /// Percentage of net revenue
  PERCENTAGE
}

enum DiscountType {
  /// Percentage off (e.g., 25%)
  PERCENTAGE
  /// Fixed amount off (e.g., 25€)
  FIXED
}

enum SenderType {
  STARTUP
  SELLER
}

enum MessageType {
  TEXT
  /// Org deal proposal (startup → leader)
  ORG_DEAL_PROPOSAL
  /// Mission invitation (startup → seller)
  MISSION_INVITE
  /// Enrollment request for PRIVATE mission (seller → startup)
  ENROLLMENT_REQUEST
}

enum MessageActionStatus {
  PENDING
  ACCEPTED
  REJECTED
  CANCELLED
}

// === MISSION REWARD ENUMS ===

enum RewardType {
  /// For sales and subscriptions
  SALE
  /// For sign-ups and leads
  LEAD
}

enum CommissionStructure {
  /// One-time payment on first purchase
  ONE_OFF
  /// Ongoing commission for subscriptions
  RECURRING
}

enum RewardStructure {
  /// Fixed amount (e.g., 10€)
  FLAT
  /// Percentage of sale (e.g., 20%)
  PERCENTAGE
}

// === MULTI-COMMISSION ENUMS ===

enum CountryFilterType {
  /// All countries allowed
  ALL
  /// Only listed countries allowed
  INCLUDE
  /// All countries except listed
  EXCLUDE
}

enum CommissionSource {
  /// Commission from lead/sign-up event
  LEAD
  /// Commission from one-time sale
  SALE
  /// Commission from subscription renewal
  RECURRING
}

// === ORGANIZATION ENUMS ===

enum OrganizationStatus {
  /// Application submitted, awaiting admin validation
  PENDING
  /// Validated by admin, org is operational
  ACTIVE
  /// Suspended by admin
  SUSPENDED
  /// Application rejected by admin
  REJECTED
}

enum OrganizationVisibility {
  /// Listed in browse, anyone can join
  PUBLIC
  /// Listed in browse, approval needed to join
  PRIVATE
  /// Hidden from browse, invite code only
  INVITE_ONLY
}

enum OrgMemberStatus {
  /// Invitation or application pending leader approval
  PENDING
  /// Active member
  ACTIVE
  /// Removed by leader
  REMOVED
}

enum OrgMissionStatus {
  /// Startup proposed the mission to the org
  PROPOSED
  /// Leader accepted, members enrolled
  ACCEPTED
  /// Leader rejected
  REJECTED
  /// Startup cancelled the arrangement
  CANCELLED
}

// === PAYOUT METHOD ENUMS ===

enum PayoutMethod {
  /// Stripe Connect Express
  STRIPE_CONNECT
  /// PayPal email payout
  PAYPAL
  /// SEPA bank transfer
  IBAN
  /// Platform balance (for gift cards)
  PLATFORM
}

enum GiftCardStatus {
  /// Requested, awaiting processing
  PENDING
  /// Being processed
  PROCESSING
  /// Card code delivered
  DELIVERED
  /// Failed to deliver
  FAILED
}

// === GIFT CARD REDEMPTION ===

/// Gift card redemption from platform balance
model GiftCardRedemption {
  id           String         @id @default(cuid())
  seller_id    String
  /// Amount in cents
  amount       Int
  /// amazon, itunes, steam, paypal_gift
  card_type    String
  /// Card code (encrypted in production)
  card_code    String?
  status       GiftCardStatus @default(PENDING)
  /// Admin note
  notes        String?
  created_at   DateTime       @default(now())
  fulfilled_at DateTime?
  Seller       Seller         @relation(fields: [seller_id], references: [id], onDelete: Cascade)

  @@index([seller_id])
  @@index([status])
}

// === STARTUP PAYMENT STATUS ===

/// Payment status from startup perspective
enum StartupPaymentStatus {
  /// Startup hasn't paid this commission yet
  UNPAID
  /// Startup has paid, commission ready for partner payout
  PAID
}

// === WALLET LEDGER (IMMUTABLE AUDIT TRAIL) ===

/// Ledger entry type - direction of money movement
enum LedgerEntryType {
  /// Money coming in (commission payout)
  CREDIT
  /// Money going out (gift card redemption)
  DEBIT
}

/// Reference type for ledger entries - what triggered this movement
enum LedgerReferenceType {
  /// Commission payout from startup
  COMMISSION
  /// Gift card redemption
  GIFT_CARD_REDEMPTION
  /// Manual adjustment by admin
  ADJUSTMENT
  /// Refund/clawback
  REFUND
}

/// Immutable ledger for tracking all wallet movements
/// Balance = SUM(CREDIT amounts) - SUM(DEBIT amounts)
/// This provides a complete audit trail for reconciliation
model WalletLedger {
  id             String              @id @default(cuid())
  seller_id      String
  /// CREDIT (money in) or DEBIT (money out)
  entry_type     LedgerEntryType
  /// Amount in cents (always positive, direction determined by entry_type)
  amount         Int
  /// What triggered this entry
  reference_type LedgerReferenceType
  /// ID of the related record (commission_id, gift_card_redemption_id, etc.)
  reference_id   String
  /// Seller's balance after this entry (cached for quick lookups)
  balance_after  Int
  /// Human-readable description
  description    String
  /// Immutable timestamp
  created_at     DateTime            @default(now())

  @@index([seller_id])
  @@index([reference_type])
  @@index([reference_id])
  @@index([created_at])
}

// === STARTUP BATCH PAYMENT ===

/// Batch payment from startup to pay multiple commissions at once
model StartupPayment {
  id                String    @id @default(cuid())
  /// Workspace making the payment
  workspace_id      String
  /// Total amount paid in cents
  total_amount      Int
  /// Sum of partner commissions in cents
  partner_total     Int
  /// Sum of Traaaction platform fees in cents (15%)
  platform_total    Int
  /// Number of commissions in this batch
  commission_count  Int
  /// Stripe payment intent ID
  stripe_payment_id String?   @unique
  /// Stripe checkout session ID
  stripe_session_id String?   @unique
  /// Payment status
  status            String    @default("PENDING")
  /// When payment was initiated
  created_at        DateTime  @default(now())
  /// When payment was confirmed
  paid_at           DateTime?

  Workspace   Workspace    @relation(fields: [workspace_id], references: [id])
  Commissions Commission[]

  @@index([workspace_id])
  @@index([status])
  @@index([created_at])
}

// === FEEDBACK SYSTEM (MVP) ===

/// User type for feedback
enum FeedbackUserType {
  STARTUP
  SELLER
}

/// Feedback status
enum FeedbackStatus {
  /// New feedback, not reviewed
  NEW
  /// Reviewed by admin
  REVIEWED
  /// Marked as resolved/implemented
  RESOLVED
  /// Archived/dismissed
  ARCHIVED
}

/// Feedback from users during MVP phase
model Feedback {
  id          String           @id @default(cuid())
  /// User who submitted the feedback
  user_id     String
  /// Email for contact
  user_email  String?
  /// Name for display
  user_name   String?
  /// Type of user (STARTUP or SELLER)
  user_type   FeedbackUserType
  /// Feedback message content
  message     String
  /// File attachments (array of URLs)
  attachments Json?
  /// Voice recording URL
  voice_url   String?
  /// Page URL where feedback was submitted
  page_url    String?
  /// Browser user agent
  user_agent  String?
  /// Status for admin tracking
  status      FeedbackStatus   @default(NEW)
  /// Admin notes
  admin_notes String?
  created_at  DateTime         @default(now())
  updated_at  DateTime         @updatedAt

  @@index([user_id])
  @@index([user_type])
  @@index([status])
  @@index([created_at])
}

// === SELLER GROUPS (EQUAL SPLIT) ===

enum SellerGroupStatus {
  /// Group is active and can receive commissions
  ACTIVE
  /// Group archived (creator left or manual archive)
  ARCHIVED
}

enum GroupMemberStatus {
  /// Active member receiving split
  ACTIVE
  /// Removed from group
  REMOVED
}

/// Seller group — equal split of commissions among members
model SellerGroup {
  id          String            @id @default(cuid())
  name        String
  description String?
  /// Seller.id of the group creator
  creator_id  String
  status      SellerGroupStatus @default(ACTIVE)
  /// Shareable invite code (nanoid(8))
  invite_code String?           @unique
  max_members Int               @default(10)
  created_at  DateTime          @default(now())
  updated_at  DateTime          @updatedAt

  Creator  Seller              @relation("GroupCreator", fields: [creator_id], references: [id])
  Members  SellerGroupMember[]
  Missions GroupMission[]

  @@index([creator_id])
  @@index([status])
}

/// Membership linking a seller to a group (ONE group per seller)
model SellerGroupMember {
  id        String            @id @default(cuid())
  group_id  String
  seller_id String            @unique  // ONE GROUP PER SELLER
  status    GroupMemberStatus @default(ACTIVE)
  joined_at DateTime          @default(now())

  Group  SellerGroup @relation(fields: [group_id], references: [id], onDelete: Cascade)
  Seller Seller      @relation(fields: [seller_id], references: [id])

  @@index([group_id])
}

/// Marketing tag for organizing short links (Apple Finder style)
model MarketingTag {
  id           String      @id @default(uuid())
  name         String
  color        String      // hex: "#EF4444", "#8B5CF6"...
  workspace_id String
  created_at   DateTime    @default(now())
  Workspace    Workspace   @relation(fields: [workspace_id], references: [id], onDelete: Cascade)
  links        ShortLink[] @relation("ShortLinkTags")

  @@unique([workspace_id, name])
  @@index([workspace_id])
}

/// Group enrollment in a mission — all active members get ShortLinks
model GroupMission {
  id          String   @id @default(cuid())
  group_id    String
  mission_id  String
  /// Seller.id who enrolled the group
  enrolled_by String
  created_at  DateTime @default(now())

  Group   SellerGroup @relation(fields: [group_id], references: [id], onDelete: Cascade)
  Mission Mission     @relation(fields: [mission_id], references: [id])

  @@unique([group_id, mission_id])
  @@index([mission_id])
}

// === MARKETING CAMPAIGNS & FOLDERS ===

enum CampaignStatus {
  ACTIVE
  PAUSED
  COMPLETED
  ARCHIVED
}

/// Marketing campaign — first-class entity for organizing links
model MarketingCampaign {
  id           String         @id @default(uuid())
  name         String
  description  String?
  /// Hex color for visual identification
  color        String?
  status       CampaignStatus @default(ACTIVE)
  start_date   DateTime?
  end_date     DateTime?
  workspace_id String
  created_at   DateTime       @default(now())
  updated_at   DateTime       @updatedAt

  Workspace Workspace   @relation(fields: [workspace_id], references: [id], onDelete: Cascade)
  links     ShortLink[]

  @@unique([workspace_id, name])
  @@index([workspace_id])
  @@index([status])
}

/// Marketing folder — hierarchical organization for links (max 2 levels)
model MarketingFolder {
  id           String   @id @default(uuid())
  name         String
  /// Hex color for visual identification
  color        String?
  /// Ordering position within parent
  position     Int      @default(0)
  workspace_id String
  /// Self-relation for sub-folders (max 2 levels: parent → child)
  parent_id    String?
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  Workspace Workspace        @relation(fields: [workspace_id], references: [id], onDelete: Cascade)
  Parent    MarketingFolder?  @relation("FolderHierarchy", fields: [parent_id], references: [id], onDelete: Cascade)
  Children  MarketingFolder[] @relation("FolderHierarchy")
  links     ShortLink[]

  @@unique([workspace_id, name, parent_id])
  @@index([workspace_id])
  @@index([parent_id])
}
