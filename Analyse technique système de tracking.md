# Implémentation Pratique - Code Examples & Setup

## 1. SCRIPT CLIENT GÉNÉRÉ

### Script HTML à Injecter
```html
<!-- Generated by Traaaction Dashboard -->
<!-- Workspace: startup_acme_xyz -->

<script
  src="https://cdn.traaaction.com/analytics/script.js"
  defer
  data-workspace-id="startup_acme_xyz"
  data-domains='{
    "refer": "acme.link",
    "site": "acmeapp.com",
    "outbound": ["checkout.acmeapp.com", "dashboard.acmeapp.com"]
  }'
  data-api-host="https://acmeapp.com/api/trx"
  data-attribution-model="last-click"
  data-query-params='["via", "ref", "utm_source"]'
  data-cookie-options='{
    "domain": ".acmeapp.com",
    "expiresInDays": 90
  }'
></script>
```

---

## 2. NEXT.JS SETUP

### app/layout.tsx
```typescript
export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en">
      <head>
        <script
          src="https://cdn.traaaction.com/analytics/script.js"
          defer
          data-workspace-id="startup_acme_xyz"
          data-domains='{
            "refer":"acme.link",
            "site":"acmeapp.com",
            "outbound":["checkout.acmeapp.com"]
          }'
          data-api-host="https://acmeapp.com/api/trx"
          data-attribution-model="last-click"
          data-query-params='["via"]'
        />
      </head>
      <body>{children}</body>
    </html>
  );
}
```

---

## 3. REVERSE PROXY SETUP

### Next.js Middleware (middleware.ts)
```typescript
import { NextRequest, NextResponse } from 'next/server';

export const config = {
  matcher: '/api/trx/:path*'
};

export async function middleware(req: NextRequest) {
  const path = req.nextUrl.pathname.replace('/api/trx', '');
  
  const response = await fetch(`https://api.traaaction.com${path}`, {
    method: req.method,
    headers: {
      'Content-Type': 'application/json',
      'User-Agent': req.headers.get('user-agent') || '',
      'X-Forwarded-For': req.headers.get('x-forwarded-for') || ''
    },
    body: req.method !== 'GET' ? req.body : undefined
  });
  
  return new NextResponse(response.body, {
    status: response.status,
    headers: {
      'Access-Control-Allow-Origin': '*',
      'Cache-Control': 'no-store'
    }
  });
}
```

### Cloudflare Worker (src/index.ts)
```typescript
export default {
  async fetch(request: Request, env: any): Promise<Response> {
    const url = new URL(request.url);
    
    if (!url.pathname.startsWith('/api/trx/')) {
      return new Response('Not found', { status: 404 });
    }
    
    const path = url.pathname.replace('/api/trx', '');
    const traaactionUrl = `https://api.traaaction.com${path}${url.search}`;
    
    const forwardedRequest = new Request(traaactionUrl, {
      method: request.method,
      headers: {
        'Content-Type': 'application/json',
        'X-Forwarded-For': request.headers.get('cf-connecting-ip') || '',
        'X-Forwarded-Proto': url.protocol.replace(':', '')
      },
      body: request.body
    });
    
    try {
      const response = await fetch(forwardedRequest);
      const responseData = await response.clone().json();
      
      return new Response(JSON.stringify(responseData), {
        status: response.status,
        headers: {
          'Content-Type': 'application/json',
          'Access-Control-Allow-Origin': '*'
        }
      });
    } catch (error) {
      return new Response(
        JSON.stringify({ error: 'Proxy failed' }),
        { status: 502 }
      );
    }
  }
};
```

---

## 4. CONVERSION TRACKING

### Lead Tracking (React Component)
```typescript
import { useAnalytics } from '@traaaction/analytics/react';
import { useState } from 'react';

export function SignupForm() {
  const { trackLead, isReady } = useAnalytics();
  const [email, setEmail] = useState('');
  const [loading, setLoading] = useState(false);

  const handleSignup = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);

    try {
      // 1. Submit to backend
      const response = await fetch('/api/signup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
      });

      if (!response.ok) throw new Error('Signup failed');

      const { userId } = await response.json();

      // 2. Track with Traaaction
      if (isReady) {
        await trackLead({
          eventName: 'SignUp',
          customerExternalId: userId,
          customerEmail: email
        });
      }

      alert('Signup successful!');
      setEmail('');
    } catch (err) {
      console.error('Error:', err);
    } finally {
      setLoading(false);
    }
  };

  return (
    <form onSubmit={handleSignup}>
      <input
        type="email"
        value={email}
        onChange={(e) => setEmail(e.target.value)}
        placeholder="Enter your email"
        required
      />
      <button type="submit" disabled={loading || !isReady}>
        Sign Up
      </button>
    </form>
  );
}
```

### Sale Tracking (Checkout)
```typescript
import { useAnalytics } from '@traaaction/analytics/react';

export function CheckoutForm() {
  const { trackSale } = useAnalytics();
  const [loading, setLoading] = useState(false);

  const handleCheckout = async (amount: number, orderId: string) => {
    setLoading(true);
    try {
      // Track sale
      await trackSale({
        eventName: 'Purchase',
        customerExternalId: userId,
        customerEmail: userEmail,
        amount: amount * 100, // in cents
        invoiceId: orderId,
        currency: 'USD',
        metadata: {
          orderSource: 'web',
          planType: 'pro'
        }
      });

      alert('Purchase successful!');
    } catch (err) {
      console.error('Tracking failed:', err);
    } finally {
      setLoading(false);
    }
  };

  return (
    <button onClick={() => handleCheckout(9999, 'order_123')}>
      Complete Purchase
    </button>
  );
}
```

---

## 5. PARTNER MANAGEMENT API

### Partner Enrollment
```typescript
export async function enrollPartner(data: {
  name: string;
  email: string;
  viaIdentifier: string;
  commissionRate: number;
}) {
  const response = await fetch('https://api.traaaction.com/partners', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${process.env.TRAAACTION_API_KEY}`
    },
    body: JSON.stringify({
      name: data.name,
      email: data.email,
      via_identifier: data.viaIdentifier,
      commission_rate: data.commissionRate,
      commission_type: 'percentage'
    })
  });

  if (!response.ok) {
    throw new Error('Failed to enroll partner');
  }

  return response.json();
}
```

### Link Generation
```typescript
export async function generateReferralLink(data: {
  partnerId: string;
  productSlug: string;
  campaignName: string;
}) {
  const response = await fetch('https://api.traaaction.com/links', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${process.env.TRAAACTION_API_KEY}`
    },
    body: JSON.stringify({
      partner_id: data.partnerId,
      domain: 'acme.link',
      key: `${data.productSlug}-${Date.now()}`,
      target_url: `https://acmeapp.com/${data.productSlug}`,
      metadata: {
        campaignName: data.campaignName,
        generatedAt: new Date().toISOString()
      }
    })
  });

  if (!response.ok) {
    throw new Error('Failed to generate link');
  }

  const link = await response.json();
  return {
    shortUrl: `https://acme.link/${link.key}`,
    trackingUrl: `https://acme.link/${link.key}?via=${link.via}`,
    qrCode: `https://api.traaaction.com/qr?url=${encodeURIComponent(link.shortUrl)}`
  };
}
```

### Partner Dashboard
```typescript
import { useEffect, useState } from 'react';

export function PartnerDashboard({ partnerId }: { partnerId: string }) {
  const [stats, setStats] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // Fetch initial stats
    fetch(`/api/partners/${partnerId}/stats`)
      .then(r => r.json())
      .then(setStats)
      .finally(() => setLoading(false));

    // Subscribe to real-time updates
    const ws = new WebSocket(`wss://api.traaaction.com/partners/${partnerId}/stats`);
    
    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      setStats(data);
    };

    return () => ws.close();
  }, [partnerId]);

  if (loading) return <div>Loading...</div>;
  if (!stats) return <div>Failed to load stats</div>;

  return (
    <div>
      <h2>Partner Dashboard</h2>
      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr' }}>
        <div>
          <h3>Clicks</h3>
          <p>{stats.totalClicks}</p>
          <small>Last 7 days: {stats.clicksLastWeek}</small>
        </div>
        <div>
          <h3>Conversions</h3>
          <p>{stats.totalConversions}</p>
          <small>Last 7 days: {stats.conversionsLastWeek}</small>
        </div>
        <div>
          <h3>Earnings</h3>
          <p>${(stats.totalEarnings / 100).toFixed(2)}</p>
          <small>Pending: ${(stats.pendingEarnings / 100).toFixed(2)}</small>
        </div>
      </div>
    </div>
  );
}
```

---

## 6. WEBHOOK HANDLING

### pages/api/webhooks/traaaction.ts
```typescript
import type { NextApiRequest, NextApiResponse } from 'next';
import crypto from 'crypto';

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  // Verify webhook signature
  const signature = req.headers['x-traaaction-signature'] as string;
  const payload = JSON.stringify(req.body);
  const expectedSignature = crypto
    .createHmac('sha256', process.env.TRAAACTION_WEBHOOK_SECRET || '')
    .update(payload)
    .digest('hex');

  if (signature !== expectedSignature) {
    return res.status(401).json({ error: 'Invalid signature' });
  }

  const { event, data } = req.body;

  try {
    switch (event) {
      case 'conversion.created':
        console.log(`Conversion created: ${data.conversionId}`);
        break;
      case 'commission.created':
        console.log(`Commission created: $${(data.amount / 100).toFixed(2)}`);
        break;
      case 'commission.approved':
        console.log(`Commission approved: $${(data.amount / 100).toFixed(2)}`);
        break;
    }

    res.status(200).json({ received: true });
  } catch (error) {
    console.error('Webhook error:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
}
```

---

## 7. SERVER-SIDE TRACKING

### pages/api/track-lead.ts
```typescript
import type { NextApiRequest, NextApiResponse } from 'next';

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  const { email, userId } = req.body;

  try {
    // Server-side tracking - 100% reliable
    const response = await fetch('https://api.traaaction.com/track/lead', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${process.env.TRAAACTION_API_KEY}`
      },
      body: JSON.stringify({
        eventName: 'SignUp',
        customerExternalId: userId,
        customerEmail: email
      })
    });

    if (!response.ok) {
      throw new Error(`Tracking API error: ${response.statusText}`);
    }

    const result = await response.json();
    res.status(200).json({ success: true, conversionId: result.id });
  } catch (error) {
    console.error('Tracking failed:', error);
    // Don't fail the signup if tracking fails
    res.status(200).json({ success: true, warning: 'Tracking failed' });
  }
}
```

---

## 8. TESTING

### Jest Test
```typescript
import { render, screen, fireEvent } from '@testing-library/react';
import { Analytics } from '@traaaction/analytics/react';
import { SignupForm } from '@/components/SignupForm';

describe('Analytics Tracking', () => {
  beforeEach(() => {
    global.fetch = jest.fn((url) => {
      if (url.includes('/track/lead')) {
        return Promise.resolve({
          ok: true,
          json: () => Promise.resolve({ id: 'conv_test123' })
        });
      }
      return Promise.reject(new Error('Unknown URL'));
    });
  });

  it('should track signup event', async () => {
    render(
      <Analytics
        workspaceId="test_workspace"
        apiHost="https://api.traaaction.local"
      >
        <SignupForm />
      </Analytics>
    );

    const emailInput = screen.getByPlaceholderText('Enter your email');
    const submitButton = screen.getByText('Sign Up');

    fireEvent.change(emailInput, { target: { value: '[email protected]' } });
    fireEvent.click(submitButton);

    await screen.findByText('Signup successful!');

    expect(global.fetch).toHaveBeenCalledWith(
      expect.stringContaining('/track/lead'),
      expect.objectContaining({
        method: 'POST'
      })
    );
  });
});
```

---

## 9. DEBUGGING CHECKLIST

### Browser Console Commands
```javascript
// Check if analytics is ready
console.log(window._traaactionAnalytics);

// Get current dub_id
console.log(
  document.cookie
    .split('; ')
    .find((row) => row.startsWith('dub_id='))
    ?.split('=')[1]
);

// Manually track event
window._traaactionAnalytics.trackLead({
  eventName: 'TestEvent',
  customerExternalId: 'test_user_123',
  customerEmail: '[email protected]'
});

// Check session storage
console.log(sessionStorage);

// Enable debug mode
window._traaactionAnalytics.setDebug(true);
```

---

## 10. DEPLOYMENT CHECKLIST

### Pre-Launch
- [ ] Analytics script added to <head>
- [ ] data-workspace-id set correctly
- [ ] data-domains configured
- [ ] data-api-host points to reverse proxy
- [ ] Reverse proxy middleware deployed
- [ ] Partner table seeded
- [ ] Webhook endpoint created
- [ ] SSL certificates valid

### Testing
- [ ] Signup tracking works
- [ ] Purchase tracking works
- [ ] Cross-domain handshake works
- [ ] Test with AdBlocker enabled
- [ ] Test in incognito mode
- [ ] Webhook signature verification works
- [ ] Partner link generation works
- [ ] Commission calculations correct

### Production
- [ ] Monitor error rates (target: < 0.1%)
- [ ] Monitor tracking latency (target: < 500ms)
- [ ] Monitor API health
- [ ] Setup alerts for failed webhooks
- [ ] Daily backup of conversion data
- [ ] Monthly reconciliation with payment processor

---

**Version:** 1.0
**Date:** January 13, 2026
